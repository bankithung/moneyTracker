<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wealth Planner Ultimate v8</title>
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --bg: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --needs: #3b82f6;
            --wants: #f59e0b;
            --savings: #10b981;
            --income: #059669; /* Dark Green for Income */
        }

        [data-theme="dark"] {
            --bg: #111827;
            --surface: #1f2937;
            --text-main: #f9fafb;
            --text-sub: #9ca3af;
            --border: #374151;
            --primary: #6366f1;
        }

        /* --- GLOBAL LAYOUT --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; 
            padding: 15px; 
            transition: background 0.3s, color 0.3s; 
            line-height: 1.5;
            box-sizing: border-box;
        }
        
        *, *:before, *:after { box-sizing: inherit; }
        
        .container { max-width: 1100px; margin: 0 auto; }

        /* --- HEADER --- */
        header { 
            background: var(--surface); 
            padding: 15px 20px; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        
        .brand { font-weight: 800; font-size: 1.3rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        
        .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .tab-btn { 
            flex: 1; 
            white-space: nowrap;
            padding: 12px; 
            border: none; 
            background: var(--surface); 
            color: var(--text-sub); 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: 0.2s; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        }
        .tab-btn.active { background: var(--primary); color: white; transform: translateY(-1px); }

        /* --- MONTH NAV --- */
        .month-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            background: var(--surface);
            padding: 15px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .month-title { font-size: 1.2rem; font-weight: 800; min-width: 180px; text-align: center; }
        .nav-btn { background: var(--bg); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display:flex; align-items:center; justify-content:center; color: var(--text-main); transition: 0.2s; }
        .nav-btn:hover { background: var(--border); }

        /* --- ADS CONTAINER --- */
        .ad-container {
            width: 100%;
            max-width: 1100px;
            margin: 0 auto 20px auto;
            background: #e5e7eb;
            text-align: center;
            padding: 10px;
            border-radius: 16px;
            min-height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 0.8rem;
        }

        /* --- CARDS & GRID --- */
        .grid-2 { display: grid; grid-template-columns: 1.8fr 1.2fr; gap: 20px; }
        .card { background: var(--surface); padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        
        /* --- INPUTS --- */
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; }
        input, select { 
            padding: 12px; 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            background: var(--surface); 
            color: var(--text-main); 
            outline: none; 
            flex: 1; 
            width: 100%; 
            min-width: 0; 
            font-size: 16px; 
        }
        input:focus, select:focus { border-color: var(--primary); }

        /* --- BUTTONS --- */
        .btn { padding: 12px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; white-space: nowrap; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-sub); }

        /* --- PAGINATION CONTROLS --- */
        .pagination { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); align-items: center; }
        .page-info { font-size: 0.85rem; color: var(--text-sub); }
        .page-btn { padding: 8px 15px; font-size: 0.85rem; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); cursor: pointer; color: var(--text-main); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- ACTION BUTTONS (EDIT/DELETE) --- */
        .action-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; transition: 0.2s; border-radius: 5px; }
        .edit-btn { color: var(--primary); margin-right: 5px; }
        .edit-btn:hover { background: rgba(79, 70, 229, 0.1); }
        .del-btn { color: var(--text-sub); }
        .del-btn:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

        /* --- DRAG & DROP STYLES --- */
        .tx-list { list-style: none; padding: 0; }
        .tx-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 0; 
            border-bottom: 1px solid var(--border); 
            align-items: center; 
            background: var(--surface);
            transition: background 0.2s, transform 0.2s;
        }
        .tx-item.income-item { border-left: 3px solid var(--success); background: rgba(16, 185, 129, 0.05); padding-left: 10px; }
        .tx-item.dragging { opacity: 0.5; background: var(--bg); border: 2px dashed var(--primary); }
        .drag-handle { cursor: grab; color: var(--text-sub); padding: 10px 10px 10px 0; font-size: 1.2rem; opacity: 0.5; touch-action: none; }
        .drag-handle:hover { opacity: 1; color: var(--primary); }

        /* --- PROGRESS BARS --- */
        .bar-group { margin-bottom: 18px; }
        .bar-label { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 6px; font-weight: 600; }
        .bar-bg { background: var(--border); height: 10px; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.5s ease; border-radius: 5px; }

        /* --- ADVISOR CARDS --- */
        .advice-card { border-left: 5px solid var(--primary); padding: 12px 15px; margin-bottom: 15px; background: rgba(0,0,0,0.02); border-radius: 0 8px 8px 0; }
        .advice-card.warning { border-color: var(--danger); background: rgba(239, 68, 68, 0.05); }
        .advice-card.good { border-color: var(--success); background: rgba(16, 185, 129, 0.05); }

        /* --- SETTINGS MODAL --- */
        #settingsModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(3px); }
        .modal-content { background: var(--surface); padding: 25px; border-radius: 20px; width: 90%; max-width: 450px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .rule-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }

        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; } 
            header { flex-direction: column; gap: 15px; align-items: flex-start; }
            header .controls { width: 100%; display: flex; justify-content: space-between; margin-top: 5px; }
            .input-group { flex-direction: column; }
            .input-group input, .input-group select, .input-group button { width: 100%; }
            .tab-nav { justify-content: space-between; }
            .rule-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <header>
        <div class="brand">
            <span>üöÄ</span> Wealth Planner
        </div>
        <div class="controls">
            <button class="btn btn-outline" onclick="openSettings()">‚öôÔ∏è Settings</button>
            <button class="btn btn-outline" onclick="toggleTheme()">üåó</button>
        </div>
    </header>

    <div class="ad-container">
        Google Ads Space (Ads will appear here after approval)
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('dashboard')">Plan & Track</button>
        <button class="tab-btn" onclick="switchTab('history')">Full History</button>
        <button class="tab-btn" onclick="switchTab('advisor')">Smart Advisor</button>
    </div>

    <div id="view-dashboard" class="view-section">
        
        <div class="month-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">&#10094;</button>
            <div class="month-title" id="currentMonthDisplay">Loading...</div>
            <button class="nav-btn" onclick="changeMonth(1)">&#10095;</button>
        </div>

        <div class="grid-2">
            <div>
                <div class="card">
                    <h3 style="margin-top:0"><span id="actionTitle">Add</span> for <span id="addLabel" style="color:var(--primary)">this month</span></h3>
                    <div class="input-group">
                        <input type="text" id="desc" placeholder="What? (e.g. Salary, Rent)">
                        <input type="number" id="amt" placeholder="Amount">
                        <select id="cat">
                            <option value="needs">Needs (Expense)</option>
                            <option value="wants">Wants (Expense)</option>
                            <option value="savings">Savings (Goal)</option>
                            <option value="income" style="color:var(--success); font-weight:bold;">‚ûï Extra Income</option>
                        </select>
                        <button id="addBtn" class="btn btn-primary" onclick="addTx()">+ Add</button>
                    </div>
                    <small id="editNotice" style="display:none; color:var(--warning); margin-top:10px;">Editing mode active. Click 'Update' to save.</small>
                </div>

                <div class="card">
                    <h3 style="margin-top:0">Transactions</h3>
                    <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:10px;">üí° Drag items to reorder them</div>
                    
                    <ul class="tx-list" id="txList">
                        </ul>
                    
                    <div class="pagination">
                        <button id="prevBtn" class="page-btn" onclick="changePage(-1)">Previous</button>
                        <span id="pageIndicator" class="page-info">Page 1</span>
                        <button id="nextBtn" class="page-btn" onclick="changePage(1)">Next</button>
                    </div>
                </div>
            </div>

            <div>
                <div class="card" style="text-align: center;">
                    <small style="color:var(--text-sub); font-weight:600; letter-spacing:1px;">REMAINING BALANCE</small>
                    <h1 id="monthBalance" style="margin: 10px 0; color:var(--primary); font-size: 2.5rem;">0</h1>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px; font-size:0.9rem; padding-top:15px; border-top:1px solid var(--border);">
                        <div>Total Income<br><b id="lblInc" style="color:var(--success); font-size:1.1rem;">0</b></div>
                        <div>Total Spent<br><b id="lblExp" style="color:var(--danger); font-size:1.1rem;">0</b></div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0">Budget Health</h3>
                    <div id="statusBars"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-history" class="view-section" style="display:none;">
        <div class="card">
            <h3>üìÖ Yearly Overview</h3>
            <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse; min-width:500px;">
                    <thead>
                        <tr style="text-align:left; border-bottom:2px solid var(--border); color:var(--text-sub);">
                            <th style="padding:10px;">Month</th>
                            <th style="padding:10px;">Total Income</th>
                            <th style="padding:10px;">Spent</th>
                            <th style="padding:10px;">Saved</th>
                            <th style="padding:10px;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <h3>Backup / Restore</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-outline" onclick="downloadBackup()">üíæ Save Data to File</button>
                <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">üìÇ Load Data File</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
        </div>
    </div>

    <div id="view-advisor" class="view-section" style="display:none;">
        <div class="card">
            <h3>ü§ñ Analysis for <span id="advisorMonth">Selected Month</span></h3>
            <div id="adviceContainer"></div>
        </div>
    </div>
    
    <div class="card" style="margin-top: 30px;">
        <h3>About Wealth Planner</h3>
        <p style="color:var(--text-sub); line-height: 1.6;">
            Wealth Planner is a privacy-focused personal finance tool designed to help users track income, expenses, and savings goals. 
            Data stays on your device. Use the Smart Advisor to optimize your 50/30/20 budget strategy.
        </p>
    </div>
</div>

<div id="settingsModal">
    <div class="modal-content">
        <h2 style="margin-top:0">Settings</h2>
        
        <label style="font-weight:600; font-size:0.9rem;">Fixed Standard Monthly Income</label>
        <div class="input-group" style="margin-bottom:15px;">
            <input type="number" id="setIncome" placeholder="0.00">
        </div>

        <label style="font-weight:600; font-size:0.9rem;">Currency Symbol</label>
        <div class="input-group" style="margin-bottom:20px;">
            <select id="setCurrency">
                <option value="$">$ Dollar</option>
                <option value="‚Çπ">‚Çπ Rupee</option>
                <option value="‚Ç¨">‚Ç¨ Euro</option>
                <option value="¬£">¬£ Pound</option>
                <option value="¬•">¬• Yen</option>
            </select>
        </div>

        <div style="border-top:1px solid var(--border); padding-top:15px; margin-bottom:20px;">
            <label style="font-weight:600; font-size:0.9rem;">Your Rules (Must sum to 100%)</label>
            <div class="rule-grid">
                <div>
                    <small>Needs %</small>
                    <input type="number" id="ruleNeeds">
                </div>
                <div>
                    <small>Wants %</small>
                    <input type="number" id="ruleWants">
                </div>
                <div>
                    <small>Save %</small>
                    <input type="number" id="ruleSavings">
                </div>
            </div>
        </div>

        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="saveSettings()">Save Changes</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeSettings()">Cancel</button>
        </div>
        <button class="btn btn-outline" style="width:100%; margin-top:15px; color:var(--danger); border-color:var(--danger)" onclick="wipeData()">Reset Everything</button>
    </div>
</div>

<script>
    // --- APP STATE ---
    let db = {
        income: 0,
        currency: '$',
        theme: 'light',
        rules: { needs: 50, wants: 30, savings: 20 },
        txs: [] // { id, desc, amt, cat, date, order }
    };
    
    let viewDate = new Date();
    let editingId = null;
    
    // Pagination State
    let currentPage = 1;
    const itemsPerPage = 5;

    // --- INIT ---
    function init() {
        const saved = localStorage.getItem('wealthPlanner_v8'); // New Version Key
        if (saved) {
            const parsed = JSON.parse(saved);
            db = { ...db, ...parsed }; 
            // Graceful handling of old versions
            if(!db.rules) db.rules = { needs: 50, wants: 30, savings: 20 };
        } else {
            openSettings();
        }
        
        applyTheme();
        render();
    }

    function saveDB() {
        localStorage.setItem('wealthPlanner_v8', JSON.stringify(db));
    }

    // --- MONTH NAV ---
    function changeMonth(offset) {
        viewDate.setMonth(viewDate.getMonth() + offset);
        currentPage = 1; // Reset to page 1 on month change
        cancelEdit();
        render();
    }

    // --- PAGINATION NAV ---
    function changePage(offset) {
        currentPage += offset;
        render(); // Rerender list
    }

    function getMonthKey(dateObj) {
        return dateObj.toISOString().slice(0, 7);
    }

    function getReadableMonth(dateObj) {
        return dateObj.toLocaleDateString('default', { month: 'long', year: 'numeric' });
    }

    // --- CORE LOGIC (ADD/EDIT/DELETE) ---
    function addTx() {
        const desc = document.getElementById('desc').value;
        const amt = parseFloat(document.getElementById('amt').value);
        const cat = document.getElementById('cat').value;

        if (!desc || isNaN(amt) || amt <= 0) return alert("Please check your inputs.");

        if (editingId) {
            // Update Existing
            const index = db.txs.findIndex(t => t.id === editingId);
            if (index !== -1) {
                db.txs[index].desc = desc;
                db.txs[index].amt = amt;
                db.txs[index].cat = cat;
            }
            editingId = null;
            resetFormUI();
        } else {
            // Create New
            const newTxDate = new Date(viewDate);
            const today = new Date();
            if(getMonthKey(newTxDate) === getMonthKey(today)) {
                newTxDate.setDate(today.getDate());
            } else {
                newTxDate.setDate(1);
            }

            // Find max order in this month to place new item at bottom
            const currentKey = getMonthKey(newTxDate);
            const monthTxs = db.txs.filter(t => t.date.startsWith(currentKey));
            const maxOrder = monthTxs.length > 0 ? Math.max(...monthTxs.map(t => t.order || 0)) : 0;

            db.txs.push({
                id: Date.now(),
                desc,
                amt,
                cat,
                date: newTxDate.toISOString(),
                order: maxOrder + 1 
            });
        }

        document.getElementById('desc').value = '';
        document.getElementById('amt').value = '';
        saveDB();
        render();
    }

    function editTx(id) {
        const t = db.txs.find(x => x.id === id);
        if(!t) return;
        document.getElementById('desc').value = t.desc;
        document.getElementById('amt').value = t.amt;
        document.getElementById('cat').value = t.cat;
        editingId = id;
        
        document.getElementById('actionTitle').innerText = "Edit";
        document.getElementById('addBtn').innerText = "Update Transaction";
        document.getElementById('addBtn').style.background = "var(--warning)";
        document.getElementById('editNotice').style.display = 'block';
        document.querySelector('.input-group').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
        editingId = null;
        document.getElementById('desc').value = '';
        document.getElementById('amt').value = '';
        resetFormUI();
    }

    function resetFormUI() {
        document.getElementById('actionTitle').innerText = "Add";
        document.getElementById('addBtn').innerText = "+ Add";
        document.getElementById('addBtn').style.background = "var(--primary)";
        document.getElementById('editNotice').style.display = 'none';
    }

    function deleteTx(id) {
        if(confirm("Delete this transaction?")) {
            if (editingId === id) cancelEdit();
            db.txs = db.txs.filter(t => t.id !== id);
            saveDB();
            render();
        }
    }

    // --- DRAG AND DROP ENGINE ---
    let draggedItem = null;

    function handleDragStart(e) {
        draggedItem = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.dataset.id); // Store ID
    }

    function handleDragOver(e) {
        e.preventDefault(); 
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        draggedItem = null;
    }

    function handleDrop(e) {
        e.stopPropagation(); 
        
        const draggedId = parseInt(e.dataTransfer.getData('text/plain'));
        const targetId = parseInt(this.dataset.id);

        if (draggedId !== targetId) {
            reorderTransactions(draggedId, targetId);
        }
        return false;
    }

    function reorderTransactions(draggedId, targetId) {
        const currentKey = getMonthKey(viewDate);
        let monthTxs = db.txs.filter(t => t.date.startsWith(currentKey)).sort((a,b) => (a.order || 0) - (b.order || 0));
        
        const fromIndex = monthTxs.findIndex(t => t.id === draggedId);
        const toIndex = monthTxs.findIndex(t => t.id === targetId);

        if(fromIndex === -1 || toIndex === -1) return;

        const [movedItem] = monthTxs.splice(fromIndex, 1);
        monthTxs.splice(toIndex, 0, movedItem);

        monthTxs.forEach((t, index) => {
            const dbItem = db.txs.find(x => x.id === t.id);
            if(dbItem) dbItem.order = index;
        });

        saveDB();
        render();
    }

    // --- RENDER ENGINE ---
    function render() {
        const currentKey = getMonthKey(viewDate);
        const cur = db.currency;

        document.getElementById('currentMonthDisplay').innerText = getReadableMonth(viewDate);
        document.getElementById('addLabel').innerText = getReadableMonth(viewDate);
        document.getElementById('advisorMonth').innerText = getReadableMonth(viewDate);

        // Filter Transactions
        let monthTxs = db.txs.filter(t => t.date.startsWith(currentKey))
                               .sort((a,b) => (a.order || 0) - (b.order || 0));
        
        // 1. Calculate Financials (Extra Income Logic)
        let spent = 0;
        let extraIncome = 0;
        let cats = { needs: 0, wants: 0, savings: 0 };

        monthTxs.forEach(t => {
            if (t.cat === 'income') {
                extraIncome += t.amt;
            } else {
                spent += t.amt;
                if(cats[t.cat] !== undefined) cats[t.cat] += t.amt;
            }
        });

        const totalIncome = db.income + extraIncome;
        const balance = totalIncome - spent;

        document.getElementById('monthBalance').innerText = cur + balance.toLocaleString();
        document.getElementById('lblInc').innerText = cur + totalIncome.toLocaleString();
        document.getElementById('lblExp').innerText = cur + spent.toLocaleString();

        // 2. Pagination Logic
        const totalItems = monthTxs.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;
        
        // Ensure currentPage is valid
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pagedTxs = monthTxs.slice(startIndex, endIndex);

        // Update Buttons
        document.getElementById('pageIndicator').innerText = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevBtn').disabled = (currentPage === 1);
        document.getElementById('nextBtn').disabled = (currentPage === totalPages);

        // 3. Render List
        const list = document.getElementById('txList');
        list.innerHTML = '';
        
        if (monthTxs.length === 0) {
            list.innerHTML = `<li style="color:var(--text-sub); text-align:center; padding:20px;">Empty budget for this month. Start planning!</li>`;
            // Hide pagination if empty
            document.querySelector('.pagination').style.display = 'none';
        } else {
             document.querySelector('.pagination').style.display = 'flex';
             pagedTxs.forEach(t => {
                const dateStr = new Date(t.date).getDate();
                let color = 'var(--text-main)';
                let isIncome = false;

                if(t.cat === 'income') { color = 'var(--success)'; isIncome = true; }
                else if(t.cat === 'needs') color = 'var(--needs)';
                else if(t.cat === 'wants') color = 'var(--wants)';
                else if(t.cat === 'savings') color = 'var(--savings)';
                
                const isEditing = t.id === editingId;
                const bgStyle = isEditing ? 'background:rgba(245, 158, 11, 0.1); border-left:3px solid var(--warning);' : '';

                const li = document.createElement('li');
                li.className = 'tx-item' + (isIncome ? ' income-item' : '');
                li.style.cssText = bgStyle;
                li.setAttribute('draggable', 'true');
                li.dataset.id = t.id; 

                // Drag Events
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragover', handleDragOver);
                li.addEventListener('dragleave', handleDragEnd);
                li.addEventListener('drop', handleDrop);
                li.addEventListener('dragend', handleDragEnd);

                const sign = isIncome ? '+' : '-';
                const catLabel = isIncome ? 'EXTRA INCOME' : t.cat;

                li.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <div class="drag-handle">‚£ø</div>
                    <div style="padding-left:${isEditing ? '10px' : '0'}">
                        <span style="font-weight:600">${t.desc}</span>
                        <br>
                        <small style="color:${color}; font-weight:bold; text-transform:uppercase; font-size:0.75rem;">${catLabel}</small> 
                        <small style="color:var(--text-sub)"> ‚Ä¢ Day ${dateStr}</small>
                    </div>
                </div>
                <div style="text-align:right; display:flex; align-items:center; gap:5px;">
                    <span style="font-weight:bold; margin-right:5px; color:${color}">${sign}${cur}${t.amt.toLocaleString()}</span>
                    <button class="action-btn edit-btn" onclick="editTx(${t.id})" title="Edit">‚úé</button>
                    <button class="action-btn del-btn" onclick="deleteTx(${t.id})" title="Delete">√ó</button>
                </div>`;
                
                list.appendChild(li);
            });
        }

        renderBars(cats, totalIncome);
        renderAdvisor(cats, spent, totalIncome);
        renderHistory();
    }

    function renderBars(cats, totalIncome) {
        const container = document.getElementById('statusBars');
        container.innerHTML = '';
        const cur = db.currency;
        const limits = {
            needs: totalIncome * (db.rules.needs / 100),
            wants: totalIncome * (db.rules.wants / 100),
            savings: totalIncome * (db.rules.savings / 100)
        };

        const draw = (label, val, max, color) => {
            let pct = max > 0 ? (val / max) * 100 : 0;
            let visualPct = pct > 100 ? 100 : pct;
            let statusColor = color;
            if(val > max) statusColor = 'var(--danger)';
            return `
            <div class="bar-group">
                <div class="bar-label">
                    <span>${label}</span>
                    <span style="color:${val > max ? 'var(--danger)' : 'inherit'}">${cur}${val.toLocaleString()} / ${cur}${max.toLocaleString()}</span>
                </div>
                <div class="bar-bg">
                    <div class="bar-fill" style="width:${visualPct}%; background:${statusColor}"></div>
                </div>
            </div>`;
        };
        container.innerHTML += draw(`Needs (${db.rules.needs}%)`, cats.needs, limits.needs, 'var(--needs)');
        container.innerHTML += draw(`Wants (${db.rules.wants}%)`, cats.wants, limits.wants, 'var(--wants)');
        container.innerHTML += draw(`Savings (${db.rules.savings}%)`, cats.savings, limits.savings, 'var(--savings)');
    }

    function renderAdvisor(cats, totalSpent, totalIncome) {
        const container = document.getElementById('adviceContainer');
        container.innerHTML = '';
        
        // Use totalIncome (Fixed + Extra) for calculations
        const incomeBase = totalIncome > 0 ? totalIncome : 1; 
        
        const totalPct = (totalSpent / incomeBase) * 100;
        const wantsPct = (cats.wants / incomeBase) * 100;
        const card = (title, text, type) => {
            container.innerHTML += `<div class="advice-card ${type}"><div style="font-weight:700; margin-bottom:5px;">${title}</div><div style="font-size:0.9rem; color:var(--text-sub)">${text}</div></div>`;
        }
        
        if(db.income === 0) return card("‚ö†Ô∏è Setup Required", "Please go to Settings and set your Monthly Income.", "warning");
        if(totalPct > 100) card("üö® Over Budget", `You are spending ${totalPct.toFixed(1)}% of your income!`, "warning");
        else if (totalPct < 85) card("‚úÖ Good Status", `You are under budget (${totalPct.toFixed(1)}%).`, "good");
        if(wantsPct > db.rules.wants) card("‚ö†Ô∏è Wants Alert", `You exceeded your "Wants" limit.`, "warning");
        if(cats.savings === 0 && totalSpent > 0) card("üí° Savings Tip", "No money allocated to Savings yet.", "");
    }

    function renderHistory() {
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = '';
        const groups = {};
        db.txs.forEach(t => {
            const m = t.date.slice(0, 7);
            if(!groups[m]) groups[m] = { spent: 0, extraInc: 0 };
            
            if(t.cat === 'income') groups[m].extraInc += t.amt;
            else groups[m].spent += t.amt;
        });

        Object.keys(groups).sort().reverse().forEach(key => {
            const [y, m] = key.split('-');
            const name = new Date(y, m-1).toLocaleString('default', { month: 'long', year: 'numeric' });
            
            const spent = groups[key].spent;
            const extra = groups[key].extraInc;
            const totalInc = db.income + extra;
            const saved = totalInc - spent;
            
            const status = saved >= 0 ? 'Saved' : 'Over';
            const statusColor = saved >= 0 ? 'var(--success)' : 'var(--danger)';
            
            tbody.innerHTML += `
            <tr style="border-bottom:1px solid var(--border)">
                <td style="padding:10px;"><b>${name}</b></td>
                <td style="padding:10px;">${db.currency}${totalInc.toLocaleString()}</td>
                <td style="padding:10px;">${db.currency}${spent.toLocaleString()}</td>
                <td style="padding:10px; color:${statusColor}">${db.currency}${saved.toLocaleString()}</td>
                <td style="padding:10px;"><span style="background:${statusColor}; color:white; padding:2px 6px; border-radius:4px; font-size:0.75rem;">${status}</span></td>
            </tr>`;
        });
    }

    // --- UI HELPERS ---
    function switchTab(id) {
        document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
        document.getElementById('view-' + id).style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        cancelEdit();
    }
    function openSettings() {
        document.getElementById('settingsModal').style.display = 'flex';
        document.getElementById('setIncome').value = db.income;
        document.getElementById('setCurrency').value = db.currency;
        document.getElementById('ruleNeeds').value = db.rules.needs;
        document.getElementById('ruleWants').value = db.rules.wants;
        document.getElementById('ruleSavings').value = db.rules.savings;
    }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function saveSettings() {
        db.income = parseFloat(document.getElementById('setIncome').value) || 0;
        db.currency = document.getElementById('setCurrency').value;
        const rn = parseFloat(document.getElementById('ruleNeeds').value) || 0;
        const rw = parseFloat(document.getElementById('ruleWants').value) || 0;
        const rs = parseFloat(document.getElementById('ruleSavings').value) || 0;
        if (Math.abs((rn + rw + rs) - 100) > 0.1) return alert("Percent rules must add up to 100%");
        db.rules = { needs: rn, wants: rw, savings: rs };
        saveDB(); render(); closeSettings();
    }
    function toggleTheme() { db.theme = db.theme === 'light' ? 'dark' : 'light'; applyTheme(); saveDB(); }
    function applyTheme() { document.body.setAttribute('data-theme', db.theme); }
    function downloadBackup() {
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        a.download = "wealth_planner_backup.json";
        a.click();
    }
    function importData(input) {
        const reader = new FileReader();
        reader.onload = e => {
            try { db = JSON.parse(e.target.result); saveDB(); render(); alert("Data restored!"); } catch(err) { alert("Error reading file"); }
        };
        reader.readAsText(input.files[0]);
    }
    function wipeData() { if(confirm("Are you sure?")) { localStorage.clear(); location.reload(); } }

    init();
</script>
</body>
</html>
